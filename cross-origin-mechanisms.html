<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Origin Mechanisms - JavaScript Security</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        /* ===== LAYOUT SYSTEM - CONSISTENT ACROSS ALL PAGES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ===== HEADER STYLES ===== */
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .logo-img {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* ===== CARD SYSTEM ===== */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid;
            font-size: 1.3rem;
        }
        
        .card-title.postmessage { border-bottom-color: #ff6b6b; }
        .card-title.cors-detail { border-bottom-color: #4ecdc4; }
        .card-title.exceptions { border-bottom-color: #45b7d1; }
        .card-title.risks { border-bottom-color: #96ceb4; }
        .card-title.mitigations { border-bottom-color: #ff9ff3; }
        .card-title.realworld { border-bottom-color: #feca57; }
        
        /* ===== CODE BLOCKS ===== */
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 5px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* ===== MESSAGE BOXES ===== */
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.95rem;
        }
        
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.95rem;
        }
        
        .danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.95rem;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.95rem;
        }
        
        .experimental {
            background: #e8f4fd;
            border: 1px solid #b3d9ff;
            color: #004085;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-size: 0.95rem;
            border-left: 4px solid #5f27cd;
        }
        
        /* ===== TABLES ===== */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .comparison-table th {
            background: #4a6491;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .comparison-table td {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .comparison-table tr:hover {
            background: #f8f9fa;
        }
        
        /* ===== LISTS ===== */
        .step-list {
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .step-list li {
            margin-bottom: 0.5rem;
        }
        
        /* ===== DEMO AREAS ===== */
        .demo-area {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        /* ===== TABS SYSTEM ===== */
        .tab-container {
            margin: 1.5rem 0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #4a6491;
            border-bottom: 3px solid #4a6491;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
            padding: 1.5rem;
            background: white;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ===== PRACTICE CARDS ===== */
        .practice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .practice-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .practice-card h4 {
            margin-bottom: 1rem;
            color: #495057;
        }
        
        /* ===== FOOTER ===== */
        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* ===== SPECIFIC COMPONENTS ===== */
        .example-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .example-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .example-card h4 {
            color: #4a6491;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mechanism-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .mechanism-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .mechanism-card.postmessage { border-left-color: #ff6b6b; }
        .mechanism-card.cors { border-left-color: #4ecdc4; }
        .mechanism-card.domain { border-left-color: #feca57; }
        
        .browser-support {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        
        .browser-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.8rem;
        }
        
        .chrome { background: #4285f4; }
        .firefox { background: #ff7139; }
        .safari { background: #00b0e6; }
        .edge { background: #0078d7; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            
            <h1>Cross-Origin Communication Mechanisms</h1>
            <p class="subtitle">Safe Ways to Relax the Same-Origin Policy and Automatic Exceptions</p>
        </header>
        
        <!-- Introduction -->
        <div class="card">
            <h2 class="card-title">Balancing Security and Functionality</h2>
            <p>While the Same-Origin Policy provides essential security, modern web applications often need legitimate cross-origin interactions. This guide covers safe mechanisms for cross-origin communication and the risks of automatic exceptions.</p>
            
            <div class="info">
                <strong>üéØ Key Concepts:</strong>
                <ul class="step-list">
                    <li><strong>postMessage API:</strong> Secure cross-window/iframe communication</li>
                    <li><strong>CORS (Cross-Origin Resource Sharing):</strong> Server-controlled resource sharing</li>
                    <li><strong>Automatic Exceptions:</strong> Built-in SOP relaxations for core web functionality</li>
                    <li><strong>Security Risks:</strong> Understanding and mitigating cross-origin threats</li>
                </ul>
            </div>
        </div>
        
        <!-- postMessage API Deep Dive -->
        <div class="card">
            <h2 class="card-title postmessage">postMessage API: Secure Cross-Origin Communication</h2>
            
            <div class="browser-support">
                <div class="browser-icon chrome">C</div>
                <span><strong>Chrome:</strong> 1.0+</span>
                
                <div class="browser-icon firefox">F</div>
                <span><strong>Firefox:</strong> 6.0+</span>
                
                <div class="browser-icon safari">S</div>
                <span><strong>Safari:</strong> 4.0+</span>
                
                <div class="browser-icon edge">E</div>
                <span><strong>Edge:</strong> 12.0+</span>
            </div>
            
            <h4>Complete postMessage Implementation Pattern:</h4>
            <div class="code-block">
// ===== PARENT WINDOW (Origin A) =====
// Embedding iframe from Origin B
const iframe = document.createElement('iframe');
iframe.src = 'https://origin-b.com/widget';
document.body.appendChild(iframe);

// Wait for iframe to load
iframe.onload = () => {
  // Send message to iframe
  iframe.contentWindow.postMessage(
    {
      type: 'AUTHENTICATION_REQUEST',
      data: {
        userId: 'user123',
        permissions: ['read', 'write']
      }
    },
    'https://origin-b.com' // TARGET ORIGIN - ALWAYS SPECIFY
  );
};

// Receive messages from iframe
window.addEventListener('message', (event) => {
  // ‚úÖ CRITICAL: Always verify sender origin
  if (event.origin !== 'https://origin-b.com') {
    console.warn('Ignoring message from untrusted origin:', event.origin);
    return;
  }
  
  // Process the message
  switch (event.data.type) {
    case 'AUTHENTICATION_RESPONSE':
      handleAuthResponse(event.data.data);
      break;
    case 'WIDGET_READY':
      initializeWidget(event.data.config);
      break;
    default:
      console.warn('Unknown message type:', event.data.type);
  }
});

// ===== IFRAME CONTENT (Origin B) =====
// Send message to parent
window.parent.postMessage(
  {
    type: 'WIDGET_READY',
    data: {
      config: { theme: 'dark', language: 'en' }
    }
  },
  'https://origin-a.com' // TARGET ORIGIN - ALWAYS SPECIFY
);

// Receive messages from parent
window.addEventListener('message', (event) => {
  // ‚úÖ CRITICAL: Always verify sender origin
  if (event.origin !== 'https://origin-a.com') {
    console.warn('Ignoring message from untrusted origin:', event.origin);
    return;
  }
  
  // Additional security: Validate message structure
  if (!event.data.type || !event.data.data) {
    console.error('Invalid message structure');
    return;
  }
  
  // Process based on message type
  if (event.data.type === 'AUTHENTICATION_REQUEST') {
    processAuthRequest(event.data.data);
    
    // Send response back
    window.parent.postMessage(
      {
        type: 'AUTHENTICATION_RESPONSE',
        data: { authenticated: true, token: 'xyz123' }
      },
      'https://origin-a.com'
    );
  }
});
            </div>
            
            <h4>Security Checklist for postMessage:</h4>
            <div class="practice-grid">
                <div class="practice-card">
                    <h4>‚úÖ Always Verify Origin</h4>
                    <p>Check <code>event.origin</code> against a whitelist of trusted origins before processing messages.</p>
                    <div class="code-block">
const trustedOrigins = [
  'https://trusted-site.com',
  'https://app.trusted-site.com'
];

if (!trustedOrigins.includes(event.origin)) {
  return; // Ignore message
}
                    </div>
                </div>
                
                <div class="practice-card">
                    <h4>‚úÖ Always Specify Target Origin</h4>
                    <p>Never use <code>postMessage(data, '*')</code> - always specify the exact target origin.</p>
                    <div class="code-block">
// ‚ùå DANGEROUS - sends to ANY origin
window.parent.postMessage(data, '*');

// ‚úÖ SECURE - sends only to specific origin
window.parent.postMessage(data, 'https://trusted-parent.com');
                    </div>
                </div>
                
                <div class="practice-card">
                    <h4>‚úÖ Validate Message Structure</h4>
                    <p>Check that messages have expected format and data types.</p>
                    <div class="code-block">
function isValidMessage(data) {
  return data && 
         typeof data === 'object' &&
         typeof data.type === 'string' &&
         'data' in data;
}

if (!isValidMessage(event.data)) {
  console.error('Invalid message structure');
  return;
}
                    </div>
                </div>
                
                <div class="practice-card">
                    <h4>‚úÖ Use Message Type System</h4>
                    <p>Define and validate message types to prevent unexpected behavior.</p>
                    <div class="code-block">
const ALLOWED_MESSAGE_TYPES = {
  AUTH_REQUEST: 'AUTH_REQUEST',
  AUTH_RESPONSE: 'AUTH_RESPONSE',
  DATA_UPDATE: 'DATA_UPDATE'
};

if (!Object.values(ALLOWED_MESSAGE_TYPES)
    .includes(event.data.type)) {
  console.warn('Unknown message type:', event.data.type);
  return;
}
                    </div>
                </div>
            </div>
            
            <div class="danger">
                <strong>‚ö†Ô∏è Common postMessage Security Mistakes:</strong>
                <ul class="step-list">
                    <li><strong>Missing origin validation:</strong> Processing messages from any origin</li>
                    <li><strong>Using wildcard target:</strong> <code>postMessage(data, '*')</code> sends data to any embedded page</li>
                    <li><strong>Trusting message data:</strong> Not validating message structure or content</li>
                    <li><strong>Not removing listeners:</strong> Leaving message listeners active after they're no longer needed</li>
                </ul>
            </div>
        </div>
        
        <!-- CORS Deep Dive -->
        <div class="demo-area">
            <h2 class="card-title cors-detail">Cross-Origin Resource Sharing (CORS) Deep Dive</h2>
            
            <h4>How CORS Works: Simple vs Preflight Requests</h4>
            
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" data-tab="simple">Simple Requests</button>
                    <button class="tab" data-tab="preflight">Preflight Requests</button>
                    <button class="tab" data-tab="credentials">With Credentials</button>
                </div>
                
                <div id="simple" class="tab-content active">
                    <h4>Simple CORS Requests</h4>
                    <p>Simple requests don't trigger preflight. They use simple methods (GET, POST, HEAD) and simple headers.</p>
                    
                    <div class="code-block">
// Client request (simple GET)
fetch('https://api.example.com/data', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded'
  }
});

// Server response headers:
// HTTP/1.1 200 OK
// Access-Control-Allow-Origin: https://your-site.com
// Vary: Origin
                    </div>
                    
                    <div class="info">
                        <strong>Simple Request Conditions:</strong>
                        <ul>
                            <li>Method: GET, POST, or HEAD</li>
                            <li>Headers: Only simple headers (Accept, Accept-Language, Content-Language, Content-Type)</li>
                            <li>Content-Type: application/x-www-form-urlencoded, multipart/form-data, or text/plain</li>
                        </ul>
                    </div>
                </div>
                
                <div id="preflight" class="tab-content">
                    <h4>Preflight CORS Requests</h4>
                    <p>Complex requests trigger a preflight OPTIONS request before the actual request.</p>
                    
                    <div class="code-block">
// Client request (triggers preflight)
fetch('https://api.example.com/data', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'X-Custom-Header': 'value'
  },
  body: JSON.stringify({ key: 'value' })
});

// Browser sends preflight OPTIONS request:
// OPTIONS /data HTTP/1.1
// Origin: https://your-site.com
// Access-Control-Request-Method: PUT
// Access-Control-Request-Headers: content-type, x-custom-header

// Server must respond to preflight:
// HTTP/1.1 204 No Content
// Access-Control-Allow-Origin: https://your-site.com
// Access-Control-Allow-Methods: GET, POST, PUT, DELETE
// Access-Control-Allow-Headers: Content-Type, X-Custom-Header
// Access-Control-Max-Age: 86400

// Then browser sends actual PUT request
                    </div>
                </div>
                
                <div id="credentials" class="tab-content">
                    <h4>CORS with Credentials (Cookies)</h4>
                    <p>When sending credentials, additional security restrictions apply.</p>
                    
                    <div class="code-block">
// Client request with credentials
fetch('https://api.example.com/user', {
  method: 'GET',
  credentials: 'include', // Send cookies
  headers: {
    'Authorization': 'Bearer token123'
  }
});

// Server response MUST include:
// HTTP/1.1 200 OK
// Access-Control-Allow-Origin: https://your-site.com  // NOT "*"!
// Access-Control-Allow-Credentials: true
// Access-Control-Allow-Headers: Authorization
// Set-Cookie: session=abc123; SameSite=None; Secure

// ‚ùå CANNOT use wildcard with credentials:
// Access-Control-Allow-Origin: *  // NOT ALLOWED with credentials
                    </div>
                    
                    <div class="danger">
                        <strong>‚ö†Ô∏è Critical Rule:</strong> When using <code>credentials: 'include'</code>, the server <strong>cannot</strong> respond with <code>Access-Control-Allow-Origin: *</code>. It must specify exact origins.
                    </div>
                </div>
            </div>
            
            <h4>Complete CORS Server Implementation:</h4>
            <div class="code-block">
// ===== EXPRESS.JS CORS MIDDLEWARE =====
const express = require('express');
const cors = require('cors');

const app = express();

// Production CORS configuration
const corsOptions = {
  origin: (origin, callback) => {
    // Allow requests with no origin (like mobile apps or curl requests)
    if (!origin) return callback(null, true);
    
    const allowedOrigins = [
      'https://production-site.com',
      'https://staging-site.com',
      'https://admin-site.com',
      'http://localhost:3000',     // Development
      'http://localhost:8080'      // Development
    ];
    
    if (allowedOrigins.includes(origin)) {
      return callback(null, true);
    } else {
      console.warn(`Blocked CORS request from: ${origin}`);
      return callback(new Error('Not allowed by CORS'));
    }
  },
  
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'X-Requested-With',
    'X-CSRF-Token',
    'X-API-Key',
    'Accept',
    'Accept-Version',
    'Content-Length',
    'Content-MD5',
    'Date',
    'X-Api-Version'
  ],
  
  exposedHeaders: [
    'X-Rate-Limit-Limit',
    'X-Rate-Limit-Remaining',
    'X-Rate-Limit-Reset',
    'X-Total-Count',
    'Link'
  ],
  
  credentials: true,  // Allow cookies
  maxAge: 86400,      // Cache preflight for 24 hours
  preflightContinue: false,
  optionsSuccessStatus: 204
};

app.use(cors(corsOptions));

// Handle preflight for all routes
app.options('*', cors(corsOptions));

// ===== MANUAL CORS IMPLEMENTATION =====
app.use((req, res, next) => {
  const origin = req.headers.origin;
  
  // Check if origin is allowed
  if (origin && allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
  }
  
  // Handle preflight requests
  if (req.method === 'OPTIONS') {
    res.setHeader('Access-Control-Allow-Methods', 
      'GET, POST, PUT, DELETE, PATCH, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 
      'Content-Type, Authorization, X-CSRF-Token');
    res.setHeader('Access-Control-Max-Age', '86400');
    
    if (req.headers['access-control-request-credentials'] === 'true') {
      res.setHeader('Access-Control-Allow-Credentials', 'true');
    }
    
    return res.status(204).end();
  }
  
  // For regular requests
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Vary', 'Origin'); // Important for caching
  
  next();
});
            </div>
        </div>
        
        <!-- Automatic Exceptions -->
        <div class="card">
            <h2 class="card-title exceptions">Automatic Exceptions: Built-in SOP Relaxations</h2>
            <p>Certain cross-origin interactions are allowed by default for core web functionality. Understanding these exceptions is crucial for security.</p>
            
            <div class="example-grid">
                <div class="example-card">
                    <h4>üìÑ Loading Scripts</h4>
                    <div class="code-block">
&lt;script src="https://cdn.example.com/library.js"&gt;&lt;/script&gt;
                    </div>
                    <p><strong>Risk:</strong> Scripts execute with full privileges of embedding page</p>
                    <p><strong>Mitigation:</strong> Use Subresource Integrity (SRI)</p>
                    <div class="code-block">
&lt;script 
  src="https://cdn.example.com/library.js"
  integrity="sha384-abc123..."
  crossorigin="anonymous"&gt;
&lt;/script&gt;
                    </div>
                </div>
                
                <div class="example-card">
                    <h4>üé® Loading Styles</h4>
                    <div class="code-block">
&lt;link 
  href="https://cdn.example.com/styles.css" 
  rel="stylesheet"&gt;
                    </div>
                    <p><strong>Risk:</strong> CSS can be used for UI redressing attacks</p>
                    <p><strong>Mitigation:</strong> Use SRI for stylesheets too</p>
                </div>
                
                <div class="example-card">
                    <h4>üñºÔ∏è Loading Images</h4>
                    <div class="code-block">
&lt;img src="https://other-site.com/image.jpg"&gt;
                    </div>
                    <p><strong>Risk:</strong> May leak information via cookies or tracking pixels</p>
                    <p><strong>Mitigation:</strong> Use <code>referrerpolicy="no-referrer"</code></p>
                </div>
                
                <div class="example-card">
                    <h4>üì¶ Embedding Content</h4>
                    <div class="code-block">
&lt;iframe src="https://other-site.com/widget"&gt;&lt;/iframe&gt;
                    </div>
                    <p><strong>Risk:</strong> Clickjacking attacks using transparent overlays</p>
                    <p><strong>Mitigation:</strong> Use X-Frame-Options or CSP frame-ancestors</p>
                </div>
                
                <div class="example-card">
                    <h4>üìù Form Submissions</h4>
                    <div class="code-block">
&lt;form action="https://bank.com/transfer" method="POST"&gt;
  &lt;input type="hidden" name="amount" value="1000"&gt;
&lt;/form&gt;
                    </div>
                    <p><strong>Risk:</strong> CSRF attacks - requests sent with user's cookies</p>
                    <p><strong>Mitigation:</strong> Anti-CSRF tokens, SameSite cookies</p>
                </div>
                
                <div class="example-card">
                    <h4>üîó Creating Links</h4>
                    <div class="code-block">
&lt;a href="https://other-site.com/page"&gt;Visit&lt;/a&gt;
                    </div>
                    <p><strong>Risk:</strong> Generally low, but can be used for phishing</p>
                    <p><strong>Mitigation:</strong> Validate URLs, use <code>rel="noopener"</code></p>
                </div>
            </div>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Important Distinction:</strong>
                <p>These exceptions allow <strong>loading/embedding</strong> but NOT <strong>reading/modifying</strong> the content. For example:</p>
                <ul class="step-list">
                    <li>‚úÖ You can load a script from another origin</li>
                    <li>‚úÖ That script will execute on your page</li>
                    <li>‚ùå You cannot read the script's source code via fetch()</li>
                    <li>‚ùå The script cannot read data from other origins (unless permitted)</li>
                </ul>
            </div>
        </div>
        
        <!-- Security Risks and Mitigations -->
        <div class="card">
            <h2 class="card-title risks">Security Risks of Cross-Origin Interactions</h2>
            
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Mechanism</th>
                        <th>Primary Risk</th>
                        <th>Attack Type</th>
                        <th>Real-World Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>postMessage</strong></td>
                        <td>Message interception</td>
                        <td>Man-in-the-middle</td>
                        <td>Malicious site embeds your widget and intercepts messages</td>
                    </tr>
                    <tr>
                        <td><strong>CORS</strong></td>
                        <td>Overly permissive origins</td>
                        <td>Data exfiltration</td>
                        <td><code>Access-Control-Allow-Origin: *</code> on sensitive API</td>
                    </tr>
                    <tr>
                        <td><strong>Script Loading</strong></td>
                        <td>Malicious code execution</td>
                        <td>Supply chain attack</td>
                        <td>Compromised CDN serving malicious JavaScript</td>
                    </tr>
                    <tr>
                        <td><strong>Form Submissions</strong></td>
                        <td>Unauthorized actions</td>
                        <td>CSRF</td>
                        <td>User tricked into submitting form to bank transfer endpoint</td>
                    </tr>
                    <tr>
                        <td><strong>Iframe Embedding</strong></td>
                        <td>UI deception</td>
                        <td>Clickjacking</td>
                        <td>Transparent iframe over "Like" button to hijack clicks</td>
                    </tr>
                    <tr>
                        <td><strong>Image Loading</strong></td>
                        <td>Information leakage</td>
                        <td>Tracking</td>
                        <td>1x1 tracking pixels sending user data via URL parameters</td>
                    </tr>
                </tbody>
            </table>
            
            <h4 class="card-title mitigations">Mitigation Strategies</h4>
            
            <div class="mechanism-comparison">
                <div class="mechanism-card postmessage">
                    <h4>postMessage Protections</h4>
                    <ul class="step-list">
                        <li>‚úÖ Always verify <code>event.origin</code></li>
                        <li>‚úÖ Never use wildcard target (<code>'*'</code>)</li>
                        <li>‚úÖ Validate message structure</li>
                        <li>‚úÖ Use message type whitelist</li>
                        <li>‚úÖ Remove listeners when done</li>
                    </ul>
                </div>
                
                <div class="mechanism-card cors">
                    <h4>CORS Protections</h4>
                    <ul class="step-list">
                        <li>‚úÖ Restrict origins to specific domains</li>
                        <li>‚úÖ Never use <code>*</code> with credentials</li>
                        <li>‚úÖ Implement proper preflight handling</li>
                        <li>‚úÖ Use <code>Vary: Origin</code> header</li>
                        <li>‚úÖ Regularly audit CORS configuration</li>
                    </ul>
                </div>
                
                <div class="mechanism-card domain">
                    <h4>Automatic Exception Protections</h4>
                    <ul class="step-list">
                        <li>‚úÖ Use Subresource Integrity (SRI)</li>
                        <li>‚úÖ Implement Content Security Policy</li>
                        <li>‚úÖ Use anti-CSRF tokens</li>
                        <li>‚úÖ Set SameSite cookie attribute</li>
                        <li>‚úÖ Use X-Frame-Options/CSP frame-ancestors</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Real-World Examples -->
        <div class="demo-area">
            <h2 class="card-title realworld">Real-World Implementation Examples</h2>
            
            <h4>Example 1: Secure Payment Widget Integration</h4>
            <div class="code-block">
// ===== E-COMMERCE SITE (https://shop.com) =====
// Embed payment widget
const iframe = document.createElement('iframe');
iframe.src = 'https://payments.com/widget?theme=dark';
iframe.style.cssText = 'border: none; width: 400px; height: 300px;';
document.getElementById('payment-container').appendChild(iframe);

// Listen for messages from payment widget
window.addEventListener('message', (event) => {
  // ‚úÖ Always verify origin
  if (event.origin !== 'https://payments.com') {
    console.error('Untrusted message origin:', event.origin);
    return;
  }
  
  // ‚úÖ Validate message structure
  if (!event.data.type || !event.data.data) {
    console.error('Invalid message structure');
    return;
  }
  
  switch (event.data.type) {
    case 'PAYMENT_COMPLETE':
      // Update order status
      completeOrder(event.data.data.orderId);
      
      // Send confirmation back
      iframe.contentWindow.postMessage(
        {
          type: 'CONFIRMATION_RECEIVED',
          data: { confirmed: true }
        },
        'https://payments.com'
      );
      break;
      
    case 'PAYMENT_FAILED':
      showErrorMessage(event.data.data.reason);
      break;
      
    default:
      console.warn('Unknown message type:', event.data.type);
  }
});

// ===== PAYMENT WIDGET (https://payments.com) =====
// Initialize and notify parent
window.parent.postMessage(
  {
    type: 'WIDGET_READY',
    data: { version: '2.1.0', features: ['card', 'paypal'] }
  },
  'https://shop.com'  // ‚úÖ Specific target origin
);

// Handle payment completion
function processPayment() {
  // ... process payment ...
  
  // Notify parent
  window.parent.postMessage(
    {
      type: 'PAYMENT_COMPLETE',
      data: { orderId: 'ORD123', amount: 99.99 }
    },
    'https://shop.com'  // ‚úÖ Specific target origin
  );
}
            </div>
            
            <h4>Example 2: Secure CORS API with Authentication</h4>
            <div class="code-block">
// ===== FRONTEND (https://app.company.com) =====
async function fetchUserData() {
  try {
    const response = await fetch('https://api.company.com/v1/user', {
      method: 'GET',
      credentials: 'include',  // Send cookies
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`,
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCsrfToken()
      }
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('Failed to fetch user data:', error);
    throw error;
  }
}

// ===== BACKEND (https://api.company.com) =====
const express = require('express');
const cors = require('cors');
const app = express();

// Secure CORS configuration
app.use(cors({
  origin: ['https://app.company.com', 'https://staging.company.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'X-CSRF-Token',
    'X-Requested-With'
  ],
  exposedHeaders: ['X-Rate-Limit-Remaining'],
  maxAge: 86400
}));

// API endpoint with CORS
app.get('/v1/user', authenticate, (req, res) => {
  // User is authenticated via middleware
  const userData = {
    id: req.user.id,
    email: req.user.email,
    role: req.user.role
  };
  
  // Set CORS headers (already done by middleware, but explicit for clarity)
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Vary', 'Origin');
  
  res.json(userData);
});

// Handle preflight for all routes
app.options('*', (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', 
    req.headers.origin || 'https://app.company.com');
  res.setHeader('Access-Control-Allow-Methods', 
    'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 
    'Content-Type, Authorization, X-CSRF-Token');
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  res.setHeader('Access-Control-Max-Age', '86400');
  res.status(204).end();
});
            </div>
        </div>
        
        <!-- Best Practices Summary -->
        <div class="card">
            <h2>‚úÖ Cross-Origin Security Best Practices</h2>
            
            <div class="practice-grid">
                <div class="practice-card">
                    <h4>For postMessage</h4>
                    <ul class="step-list">
                        <li>‚úÖ Always validate <code>event.origin</code></li>
                        <li>‚úÖ Never use wildcard target (<code>'*'</code>)</li>
                        <li>‚úÖ Define and validate message types</li>
                        <li>‚úÖ Use structured message format</li>
                        <li>‚úÖ Clean up listeners when done</li>
                    </ul>
                </div>
                
                <div class="practice-card">
                    <h4>For CORS</h4>
                    <ul class="step-list">
                        <li>‚úÖ Restrict origins to specific domains</li>
                        <li>‚úÖ Never use <code>*</code> with credentials</li>
                        <li>‚úÖ Implement proper preflight handling</li>
                        <li>‚úÖ Use <code>Vary: Origin</code> for caching</li>
                        <li>‚úÖ Regularly audit CORS configuration</li>
                    </ul>
                </div>
                
                <div class="practice-card">
                    <h4>For Automatic Exceptions</h4>
                    <ul class="step-list">
                        <li>‚úÖ Use Subresource Integrity for external resources</li>
                        <li>‚úÖ Implement Content Security Policy</li>
                        <li>‚úÖ Use anti-CSRF tokens for forms</li>
                        <li>‚úÖ Set <code>SameSite</code> cookie attribute</li>
                        <li>‚úÖ Control framing with CSP/X-Frame-Options</li>
                    </ul>
                </div>
            </div>
            
            <div class="info" style="margin-top: 1rem;">
                <strong>üéØ Security-First Mindset:</strong>
                <ol class="step-list">
                    <li><strong>Default Deny:</strong> Start with strict SOP enforcement</li>
                    <li><strong>Explicit Allow:</strong> Only relax SOP when absolutely necessary</li>
                    <li><strong>Minimum Privilege:</strong> Grant the minimum access required</li>
                    <li><strong>Continuous Validation:</strong> Validate all cross-origin interactions</li>
                    <li><strong>Defense in Depth:</strong> Use multiple layers of protection</li>
                </ol>
            </div>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Critical Reminder:</strong>
                <p>The Same-Origin Policy prevents <strong>reading responses</strong> from cross-origin requests, but <strong>does not prevent sending requests</strong>. Always implement CSRF protection on state-changing endpoints, regardless of CORS configuration.</p>
            </div>
        </div>
        
                <footer>
                <!-- Primeira linha: Refer√™ncia ao curso -->
                <p style="margin-bottom: 0.5rem;">
                    <strong>Based on "Introduction to JavaScript Security (LFS184)" by The Linux Foundation</strong>
                </p>
                
                <!-- Segunda linha: Informa√ß√µes de licen√ßa e autoria -->
                <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                    Security education reference ‚Ä¢ Created for learning and demonstration purposes ‚Ä¢ Licensed under 
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/" 
                    target="_blank" 
                    style="color: #4a6491; text-decoration: none; font-weight: 600;">
                        CC-BY-SA-4.0
                    </a>
                </p>
                
                <!-- Terceira linha: Informa√ß√µes pessoais -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <span style="color: #4a6491; font-weight: 600;">¬© Iure Castro</span>
                    <span style="color: #666;">‚Ä¢</span>
                    <span>Personal learning portfolio</span>
                    <span style="color: #666;">‚Ä¢</span>
                    <span>All examples for educational use</span>
                </div>
                
                <!-- Quarta linha: Links √∫teis -->
                <div style="display: flex; justify-content: center; gap: 1.5rem; margin: 1rem 0; flex-wrap: wrap;">
                    <a href="https://training.linuxfoundation.org/training/introduction-to-javascript-security-lfs184/" 
                    target="_blank"
                    style="color: #4a6491; text-decoration: none; font-size: 0.9rem;">
                        üîó Original Course
                    </a>
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/" 
                    target="_blank"
                    style="color: #4a6491; text-decoration: none; font-size: 0.9rem;">
                        üìÑ CC-BY-SA-4.0 License
                    </a>
                    <a href="certificate.pdf" 
                    target="_blank"
                    style="color: #4a6491; text-decoration: none; font-size: 0.9rem;">
                        üèÜ My Certificate
                    </a>
                </div>
        </footer>
    </div>

    <script>
        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabContainer = tab.closest('.tab-container');
                
                // Remove active class from all tabs in this container
                tabContainer.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Remove active class from all contents in this container
                tabContainer.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                });
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabId = tab.getAttribute('data-tab');
                const content = tabContainer.querySelector(`#${tabId}`);
                if (content) {
                    content.classList.add('active');
                }
            });
        });
        
        // postMessage security demo
        function simulatePostMessage() {
            const messageType = document.getElementById('message-type').value;
            const targetOrigin = document.getElementById('target-origin').value;
            const verifyOrigin = document.getElementById('verify-origin').checked;
            
            const demoResult = document.getElementById('postmessage-result');
            
            let resultHTML = '';
            
            if (targetOrigin === '*' && verifyOrigin) {
                resultHTML = `
                    <div class="danger">
                        <h4>‚ùå SECURITY RISK DETECTED</h4>
                        <p>Using wildcard target origin (<code>'*'</code>) with origin verification is contradictory and dangerous.</p>
                        <p><strong>Attack Scenario:</strong> Malicious site embeds your iframe and receives all messages.</p>
                        <p><strong>Fix:</strong> Always specify exact target origin in postMessage.</p>
                    </div>
                `;
            } else if (!verifyOrigin) {
                resultHTML = `
                    <div class="danger">
                        <h4>‚ùå SECURITY RISK DETECTED</h4>
                        <p>Not verifying message origins allows any site to send messages to your application.</p>
                        <p><strong>Attack Scenario:</strong> Attacker sends fake "payment complete" message.</p>
                        <p><strong>Fix:</strong> Always verify <code>event.origin</code> against trusted origins.</p>
                    </div>
                `;
            } else if (targetOrigin === '*') {
                resultHTML = `
                    <div class="warning">
                        <h4>‚ö†Ô∏è SECURITY WARNING</h4>
                        <p>Using wildcard target origin (<code>'*'</code>) sends messages to ANY embedded page.</p>
                        <p>Only use this for public broadcasts where secrecy isn't required.</p>
                    </div>
                `;
            } else {
                resultHTML = `
                    <div class="success">
                        <h4>‚úÖ SECURE CONFIGURATION</h4>
                        <p><strong>Message Type:</strong> ${messageType}</p>
                        <p><strong>Target Origin:</strong> ${targetOrigin}</p>
                        <p><strong>Origin Verification:</strong> ${verifyOrigin ? 'Enabled' : 'Disabled'}</p>
                        <p>This configuration follows security best practices.</p>
                    </div>
                `;
            }
            
            demoResult.innerHTML = resultHTML;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`
            Cross-Origin Mechanisms Guide - Key Takeaways:
            
            1. POSTMESSAGE API:
               - Enables secure cross-window/iframe communication
               - ALWAYS verify event.origin before processing messages
               - NEVER use wildcard target ('*') for sensitive data
               - Validate message structure and types
            
            2. CORS (CROSS-ORIGIN RESOURCE SHARING):
               - Server-controlled mechanism for sharing resources
               - Simple vs preflight requests (automatic detection)
               - Credentials require specific origins (no wildcards)
               - Always implement proper preflight handling
            
            3. AUTOMATIC EXCEPTIONS:
               - Scripts, styles, images, forms, iframes can be loaded cross-origin
               - These are allowed for web functionality
               - But reading/modifying the content is still restricted
               - Mitigate risks with SRI, CSP, anti-CSRF tokens
            
            4. SECURITY MINDSET:
               - Default deny, explicit allow
               - Minimum privilege principle
               - Continuous validation
               - Defense in depth
            
            5. CRITICAL REMINDER:
               - SOP prevents READING responses, not SENDING requests
               - CSRF protection is STILL NEEDED on state-changing endpoints
               - Even with CORS properly configured
            
            Security is not a feature - it's a fundamental requirement.
            `);
            
            // Initialize postMessage demo
            simulatePostMessage();
        });
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
</body>
</html>